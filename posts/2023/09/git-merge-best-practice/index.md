# git merge最佳实践


使用git merge最棘手的问题就是会产生合并冲突，即merge conflicts。由于多人协作，冲突的问题大概是不可避免的，因此本文旨在尽量减少冲突，以及快速解决那些不可避免的冲突。


## 尽量减少冲突 {#尽量减少冲突}


### 理解冲突产生的原因 {#理解冲突产生的原因}

Merge总是发生在两个分支之间，而它们的不一致有可能导致冲突。git系统会尽量自动解决冲突，但在某些它认为存在风险的情况下，会留给用户做最后的决定。大概有这么几种情况：

1.  被merge的两个分支修改了同一文件的同一行
2.  分支A删除了某文件，分支B修改该文件
3.  分支A删除了某文件中的某行，分支B修改该文件的该行


### 减少冲突的方法 {#减少冲突的方法}

1.  保持格式化规则的一致性。如果不同开发者使用不同的格式化风格，自动格式化工具就很可能会改到别的开发者的代码，就会产生冲突。
2.  提高PR的频率。不要等积攒了一大堆改动后再推送，特别是在会跟其他人修改同一文件的情况下。
3.  在本地尽量使用rebase。rebase会使commit历史更加线性化整洁化，相当于先把远程分支的更改同步到本地，然后在此基础上应用自己本地的修改。
    这样可以把冲突尽量局限在本地，而减少合并到远程分支时的冲突。
    需要注意的是不要在公共分支rebase，因为rebase会修改commit历史，很容易给协作者带来麻烦，请参见[rebase的工作原理](https://waynerv.com/posts/git-rebase-intro/)。
4.  跟协作者沟通并建立约定。工具不能代替现实的沟通交流。


## 解决冲突 {#解决冲突}

解决冲突最简便易行的方法是使用emacs ediff工具。


### 使用Emacs ediff解决冲突 {#使用emacs-ediff解决冲突}

在magit状态界面下，把光标移动到unmerged那一行，按e，就会打开ediff。
打开ediff后会出现如下界面，整个frame被分为了A, B, C三块窗口：

{{< figure src="/ox-hugo/2023-09-22_14-21-31_screenshot.png" >}}

其中A代表目前正在操作的分支，B代表想要merge的目标分支，C代表merge的期望效果。
在这个界面下，按n/p可以在冲突点之间移动光标，定位到某个冲突点后，按a表示采纳窗口A的更改，按b表示采纳窗口B的更改，
采纳之后的效果会显示在窗口C。当然也可以在窗口C直接修改。将当前文件的冲突解决完后，按q退出ediff-session，这时会提醒用户保存文件，按y即可。
接下来，解决其他文件的冲突，循环往复直到所有冲突都解决。


### 进阶用法 {#进阶用法}

从magit进入ediff稍微有点繁琐，可以使用[这个方法](https://stackoverflow.com/a/8244305)使该过程更加自动化。（需要根据自己的系统情况做一些修改）
其基本思路是写一个shell脚本调用emacs并进入ediff，然后使git mergetool调用该脚本。最终达到能通过git mergetool直接进入到ediff界面解决冲突。

